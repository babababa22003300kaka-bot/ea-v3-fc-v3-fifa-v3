# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘           ğŸ”¥ ACTIVE MESSAGE SYSTEM - Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø´Ø·Ø©                â•‘
# â•‘             Ù…Ù†Ø¸Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - Conversation Cleaner              â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

"""
ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø´Ø·Ø© - Active Message System

Ø§Ù„Ù‡Ø¯Ù:
-------
Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø¸Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©.

Ø§Ù„Ø¢Ù„ÙŠØ©:
-------
1. ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø±Ø³Ø§Ù„Ø© Ù†Ø´Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (message_id Ù…Ø­ÙÙˆØ¸ ÙÙŠ bucket)
2. Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©:
   - Ù„Ùˆ ÙÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© â†’ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
   - Ù„Ùˆ Ù…ÙÙŠØ´ â†’ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ù€ ID
3. Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© â†’ Ù…Ø³Ø­ Ø§Ù„Ù€ ID Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©

Ø§Ù„ÙÙˆØ§Ø¦Ø¯:
--------
âœ… Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø¸ÙŠÙØ© ÙˆÙ…Ù†Ø¸Ù…Ø©
âœ… ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø­ØªØ±Ø§ÙÙŠØ©
âœ… Ø³Ù‡Ù„ Ø§Ù„ØªÙƒØ§Ù…Ù„ (Ø¯Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
âœ… Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ bucket system Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ (Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ©)

Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
----------
# Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†:
await update.message.reply_text(text, reply_markup=keyboard, parse_mode="HTML")

# Ø§Ø³ØªØ®Ø¯Ù…:
await send_or_edit(context, update.effective_chat.id, text, keyboard)

# ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:
clear_active_message(context)
"""

from telegram.error import BadRequest
from utils.session_bucket import bucket, clear_bucket
import logging

logger = logging.getLogger(__name__)


async def send_or_edit(
    context,
    chat_id: int,
    text: str,
    keyboard=None,
    parse_mode: str = "HTML",
):
    """
    ğŸ”¥ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©

    Args:
        context: telegram.ext.ContextTypes.DEFAULT_TYPE
        chat_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        text: Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        keyboard: InlineKeyboardMarkup (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        parse_mode: Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: HTML)

    Returns:
        Message: Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©/Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©

    Ø§Ù„Ø¢Ù„ÙŠØ©:
    ------
    1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† message_id ÙÙŠ active_message bucket
    2. Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ â†’ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    3. Ù„Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙØ´Ù„ â†’ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    4. Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ â†’ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    5. Ø­ÙØ¸ message_id Ø§Ù„Ø¬Ø¯ÙŠØ¯

    Example:
        >>> await send_or_edit(
        ...     context,
        ...     update.effective_chat.id,
        ...     "âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØµØ©",
        ...     keyboard
        ... )
    """
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ bucket Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    active_message_bucket = bucket(context, "active_message")
    message_id = active_message_bucket.get("message_id")

    print(f"\nğŸ”¥ [ACTIVE-MSG] send_or_edit called")
    print(f"   ğŸ“ Chat ID: {chat_id}")
    print(f"   ğŸ“ Message ID in bucket: {message_id}")

    try:
        if message_id:
            # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            print(f"   âœï¸ [ACTIVE-MSG] Attempting to EDIT message {message_id}")

            message = await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=text,
                reply_markup=keyboard,
                parse_mode=parse_mode,
            )

            print(f"   âœ… [ACTIVE-MSG] Message EDITED successfully")
            return message

        else:
            # Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© - Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            print(f"   ğŸ“¤ [ACTIVE-MSG] No old message - SENDING new one")

            message = await context.bot.send_message(
                chat_id=chat_id,
                text=text,
                reply_markup=keyboard,
                parse_mode=parse_mode,
            )

            # Ø­ÙØ¸ message_id Ø§Ù„Ø¬Ø¯ÙŠØ¯
            active_message_bucket["message_id"] = message.message_id
            print(f"   âœ… [ACTIVE-MSG] New message SENT - ID: {message.message_id}")
            print(f"   ğŸ’¾ [ACTIVE-MSG] Message ID saved in bucket")
            return message

    except BadRequest as e:
        # ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ© Ø£Ùˆ Ù‚Ø¯ÙŠÙ…Ø© Ø¬Ø¯Ø§Ù‹)
        print(f"   âš ï¸ [ACTIVE-MSG] Edit FAILED (BadRequest): {e}")
        print(f"   ğŸ”„ [ACTIVE-MSG] Fallback: SENDING new message")

        try:
            message = await context.bot.send_message(
                chat_id=chat_id,
                text=text,
                reply_markup=keyboard,
                parse_mode=parse_mode,
            )

            # ØªØ­Ø¯ÙŠØ« message_id Ø§Ù„Ø¬Ø¯ÙŠØ¯
            active_message_bucket["message_id"] = message.message_id
            print(f"   âœ… [ACTIVE-MSG] Fallback message SENT - ID: {message.message_id}")
            print(f"   ğŸ’¾ [ACTIVE-MSG] Message ID updated in bucket")
            return message

        except Exception as fallback_error:
            print(f"   âŒ [ACTIVE-MSG] Fallback FAILED: {fallback_error}")
            logger.error(
                f"Failed to send message after edit failed: {fallback_error}"
            )
            return None

    except Exception as e:
        # Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹
        print(f"   âŒ [ACTIVE-MSG] Unexpected error: {e}")
        logger.error(f"Unexpected error in send_or_edit: {e}")
        return None


def clear_active_message(context):
    """
    ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©

    Args:
        context: telegram.ext.ContextTypes.DEFAULT_TYPE

    Usage:
        ÙŠÙØ³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (ConversationHandler.END)

    Example:
        >>> clear_active_message(context)
        >>> return ConversationHandler.END

    Notes:
        - Ù„Ø§ ÙŠØ­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Telegram (ØªØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©)
        - ÙÙ‚Ø· ÙŠÙ…Ø³Ø­ message_id Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        - Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù‡ØªØ¨Ø¯Ø£ Ø¨Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    """
    print(f"\nğŸ§¹ [ACTIVE-MSG] Clearing active message from memory")
    clear_bucket(context, "active_message")
    print(f"   âœ… [ACTIVE-MSG] Active message bucket cleared")


def get_active_message_id(context):
    """
    ğŸ” Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ message_id Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„ÙØ­Øµ ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±)

    Args:
        context: telegram.ext.ContextTypes.DEFAULT_TYPE

    Returns:
        int or None: message_id Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯

    Example:
        >>> message_id = get_active_message_id(context)
        >>> print(f"Current active message: {message_id}")
    """
    return bucket(context, "active_message").get("message_id")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ§ª TESTING (Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø·)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == "__main__":
    print("ğŸ§ª Testing Active Message Helper...\n")

    # Ù…Ø­Ø§ÙƒØ§Ø© context
    class MockContext:
        def __init__(self):
            self.user_data = {}

    context = MockContext()

    # Ø§Ø®ØªØ¨Ø§Ø± 1: Ø­ÙØ¸ message_id
    print("Test 1: Saving message_id...")
    bucket(context, "active_message")["message_id"] = 12345
    assert get_active_message_id(context) == 12345
    print("âœ… Passed\n")

    # Ø§Ø®ØªØ¨Ø§Ø± 2: Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    print("Test 2: Clearing active message...")
    clear_active_message(context)
    assert get_active_message_id(context) is None
    print("âœ… Passed\n")

    print("ğŸ‰ All tests passed!")
    print("\nğŸ“ Active Message Helper is ready for production!")
